#!/usr/bin/env bash
# Pre-commit hook: test gates + auto-rebuild console build artifacts
#
# 1a. Python unit tests  — when launcher/ or pilot/hooks/ changed
# 1b. Installer tests    — when installer/ changed
# 2.  Console unit tests — when console/ changed
# 3.  Console typecheck + build + stage artifacts — when console/src/ changed

set -eo pipefail

# --- 1. Python unit tests ---
LAUNCHER_CHANGED=$(git diff --cached --name-only -- 'launcher/' 'pilot/hooks/' | head -1)
INSTALLER_CHANGED=$(git diff --cached --name-only -- 'installer/' | head -1)

if [ -n "$LAUNCHER_CHANGED" ]; then
  echo "[pre-commit] Python source changed — running unit tests..."
  uv run pytest launcher/tests/ pilot/hooks/tests/ -q --tb=short 2>&1 | tail -20
  echo "[pre-commit] Python unit tests passed."
fi

if [ -n "$INSTALLER_CHANGED" ]; then
  echo "[pre-commit] Installer changed — running installer unit tests..."
  uv run pytest installer/tests/unit/ -q --tb=short 2>&1 | tail -20
  echo "[pre-commit] Installer unit tests passed."
fi

# --- 2. Console unit tests ---
CONSOLE_CHANGED=$(git diff --cached --name-only -- 'console/src/' 'console/scripts/' 'console/package.json' 'console/tsconfig.json' 'console/vite.config.ts' | head -1)

if [ -n "$CONSOLE_CHANGED" ]; then
  # Verify node_modules exist
  if [ ! -d "console/node_modules" ]; then
    echo "[pre-commit] ERROR: console/node_modules missing. Run: cd console && bun install"
    exit 1
  fi

  echo "[pre-commit] Console source changed — running unit tests..."
  (cd console && bun test 2>&1) | tail -20
  echo "[pre-commit] Console unit tests passed."

  # --- 3. Console typecheck + build + stage artifacts ---
  echo "[pre-commit] Running typecheck..."
  (cd console && bun run typecheck 2>&1) | tail -20
  echo "[pre-commit] Console typecheck passed."

  echo "[pre-commit] Rebuilding console artifacts..."
  (cd console && npm run build 2>&1) | tail -3
  echo ""

  # Build artifacts that must stay in sync with console source
  ARTIFACTS=(
    "pilot/scripts/mcp-server.cjs"
    "pilot/scripts/worker-service.cjs"
    "pilot/scripts/context-generator.cjs"
    "pilot/scripts/worker-wrapper.cjs"
    "pilot/ui/viewer-bundle.js"
    "pilot/ui/viewer.css"
  )

  git add "${ARTIFACTS[@]}"
  echo "[pre-commit] Console artifacts rebuilt and staged."
fi
